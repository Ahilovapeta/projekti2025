using System;
using System.Linq;
using System.Windows.Forms;
using System.Collections.Generic;

namespace VideoMaster
{
    public partial class formPreporukaFilmova : Form
    {
        private PI2324_02_DBEntities DB_Entities;
        private Korisnik OdabraniKorisnik;
        private List<int> preskoceniFilmovi = new List<int>();

        public formPreporukaFilmova(Korisnik korisnik)
        {
            InitializeComponent();
            DB_Entities = new PI2324_02_DBEntities();
            OdabraniKorisnik = korisnik;
            UcitajPreporuke();
        }

        private void UcitajPreporuke()
        {
            List<int> zanrovi = new List<int>();
            List<int> brojevi = new List<int>();

            foreach (var gleda in DB_Entities.Gleda)
            {
                if (gleda.ID_Korisnik == OdabraniKorisnik.ID_Korisnik && gleda.Film != null && gleda.Film.Zanr != null)
                {
                    int idZanr = gleda.Film.ID_Zanr;
                    int index = zanrovi.IndexOf(idZanr);
                    if (index >= 0)
                    {
                        brojevi[index]++;
                    }
                    else
                    {
                        zanrovi.Add(idZanr);
                        brojevi.Add(1);
                    }
                }
            }

            int najzanrId = 0;
            int maxBroj = 0;
            for (int i = 0; i < zanrovi.Count; i++)
            {
                if (brojevi[i] > maxBroj)
                {
                    maxBroj = brojevi[i];
                    najzanrId = zanrovi[i];
                }
            }

            if (najzanrId != 0)
            {
                List<object> preporuceniFilmovi = new List<object>();
                foreach (var film in DB_Entities.Film)
                {
                    if (film.ID_Zanr == najzanrId && !preskoceniFilmovi.Contains(film.ID_Film))
                    {
                        preporuceniFilmovi.Add(new { film.ID_Film, film.Adresa_url, film.Naziv, film.Datum_izdavanja });
                    }
                }
                dgvPreporuke.DataSource = preporuceniFilmovi;
                if (dgvPreporuke.Columns["ID_Film"] != null) dgvPreporuke.Columns["ID_Film"].Visible = false;
                if (dgvPreporuke.Columns["Adresa_url"] != null) dgvPreporuke.Columns["Adresa_url"].Visible = false;
            }
            else
            {
                dgvPreporuke.DataSource = null;
                MessageBox.Show("Nema dovoljno podataka za preporuku.");
            }
        }

        private void btnNatrag_Click(object sender, EventArgs e)
        {
            this.Hide();
            var pocetnaForm = new formIndividualniKorisnikPocetna(OdabraniKorisnik);
            pocetnaForm.ShowDialog();
            this.Close();
        }

        private void btnGledaj_Click(object sender, EventArgs e)
        {
            this.Hide();
            var formFilm = new formFilm(Convert.ToInt32(dgvPreporuke.SelectedRows[0].Cells["ID_Film"].Value.ToString()), dgvPreporuke.SelectedRows[0].Cells["Naziv"].Value.ToString(), dgvPreporuke.SelectedRows[0].Cells["Adresa_url"].Value.ToString(), OdabraniKorisnik);
            formFilm.ShowDialog();
            this.Close();
        }

        private void btnPreskoci_Click(object sender, EventArgs e)
        {
            foreach (DataGridViewRow row in dgvPreporuke.Rows)
            {
                if (row.DataBoundItem != null)
                {
                    int id = Convert.ToInt32(row.Cells["ID_Film"].Value);
                    if (!preskoceniFilmovi.Contains(id))
                    {
                        preskoceniFilmovi.Add(id);
                    }
                }
            }
            UcitajPreporuke();
        }
    }
}
