using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows.Forms;
using VideoMaster.Iznimke;


namespace VideoMaster
{
    // Forma za registraciju novog korisnika u aplikaciji
    public partial class formRegistracija : Form
    {
        // Entity Framework kontekst za rad s bazom podataka
        private PI2324_02_DBEntities DB_Entities = new PI2324_02_DBEntities();

        // Konstruktor forme - inicijalizira kontrole i postavlja HelpProvider
        public formRegistracija()
        {
            InitializeComponent();

            // Postavljanje putanje do dokumentacije za F1 pomoć
            helpProvider1 = new HelpProvider();
            string baseDirectory = AppDomain.CurrentDomain.BaseDirectory;
            string projectDirectory = Directory.GetParent(baseDirectory).Parent.Parent.FullName;
            string documentationPath = Path.Combine(projectDirectory, "F1", "formRegistracija.html");

            // Provjera postoji li dokumentacija
            if (!File.Exists(documentationPath))
            {
                MessageBox.Show("Datoteka s dokumentacijom ne postoji: " + documentationPath);
            }
            else
            {
                helpProvider1.HelpNamespace = documentationPath;
                helpProvider1.SetHelpNavigator(this, HelpNavigator.TableOfContents);
            }

            // Dodavanje event handlera za gumb Registracija
            btnRegistracija.Click += btnRegistracija_Click;
        }

        // Omogućuje otvaranje dokumentacije pritiskom na F1
        protected override bool ProcessCmdKey(ref Message msg, Keys keyData)
        {
            if (keyData == Keys.F1)
            {
                Help.ShowHelp(this, helpProvider1.HelpNamespace);
                return true;
            }
            return base.ProcessCmdKey(ref msg, keyData);
        }

        // Zatvara formu kada se klikne gumb Natrag
        private void btnNatrag_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        // Glavna logika za registraciju korisnika
        private void btnRegistracija_Click(object sender, EventArgs e)
        {
            // Dohvaćanje podataka iz tekstualnih polja
            string ime = txtIme.Text;
            string prezime = txtPrezime.Text;
            string korisnickoIme = txtKorisnickoIme.Text;
            string email = txtEmail.Text;
            string lozinka = txtLozinka.Text;
            string potvrdiLozinku = txtPotvrdiLozinku.Text;

            // Validacija: sva polja moraju biti popunjena
            if (ime == null || ime == "" ||
                prezime == null || prezime == "" ||
                korisnickoIme == null || korisnickoIme == "" ||
                email == null || email == "" ||
                lozinka == null || lozinka == "" ||
                potvrdiLozinku == null || potvrdiLozinku == "")
            {
                var ex = new RegistracijaException("Sva polja su obavezna");
                MessageBox.Show(ex.Poruka);
                return;
            }

            // Validacija: email mora biti u ispravnom formatu
            string emailPattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
            if (!Regex.IsMatch(email, emailPattern))
            {
                var ex = new RegistracijaException("Email nije u ispravnom formatu (npr. korisnik@domena.com)");
                MessageBox.Show(ex.Poruka);
                return;
            }

            // Validacija: lozinka i potvrda lozinke moraju biti iste
            if (lozinka != potvrdiLozinku)
            {
                var ex = new RegistracijaException("Niste potvrdili lozinku, oba polja za lozinku moraju biti ista");
                MessageBox.Show(ex.Poruka);
                return;
            }

            // Provjera jedinstvenosti korisničkog imena
            if (DB_Entities.Korisnik.Any(k => k.Nadimak == korisnickoIme))
            {
                var ex = new RegistracijaException("Korisničko ime je već zauzeto");
                MessageBox.Show(ex.Poruka);
                return;
            }

            // Kreiranje novog korisnika i dodavanje u bazu
            var noviKorisnik = new Korisnik
            {
                Ime = ime,
                Prezime = prezime,
                Nadimak = korisnickoIme,
                Email = email,
                Lozinka = lozinka,
                Datum_izrade_racuna = DateTime.Now,
                ID_Uloga = 3 // ID za individualnog korisnika
            };
            DB_Entities.Korisnik.Add(noviKorisnik);

            // Spremanje promjena u bazu i prikaz poruke o uspjehu
            try
            {
                DB_Entities.SaveChanges();
                MessageBox.Show("Registracija uspješna! Sada se možete prijaviti.");
                this.Close();
            }
            // Prikaz poruke o grešci ako registracija nije uspjela
            catch (RegistracijaException rex)
            {
                MessageBox.Show($"Registracija nije uspjela: {rex.Poruka}");
            }
        }
    }
}
