using System;
using System.Data;
using System.Linq;
using System.Windows.Forms;

namespace VideoMaster
{
    public partial class formPovijestGledanja : Form
    {
        private PI2324_02_DBEntities DB_Entities;
        private Korisnik OdabraniKorisnik;

        public formPovijestGledanja(Korisnik korisnik)
        {
            InitializeComponent();
            DB_Entities = new PI2324_02_DBEntities();
            OdabraniKorisnik = korisnik;
            UcitajPovijest();
            UcitajStatistiku();
        }

        private void UcitajPovijest()
        {
            var povijest = DB_Entities.Gleda
                .Where(g => g.ID_Korisnik == OdabraniKorisnik.ID_Korisnik)
                .OrderByDescending(g => g.Datum_gledanja)
                .Select(g => new
                {
                    Film = g.Film.Naziv,
                    Zanr = g.Film.Zanr.Naziv,
                    Ocjena = g.Ocjena,
                    Datum = g.Datum_gledanja,
                    Komentar = g.Komentar
                })
                .ToList();
            dgvPovijest.DataSource = povijest;
        }

        private void UcitajStatistiku()
        {
            var zanrStat = DB_Entities.Gleda
                .Where(g => g.ID_Korisnik == OdabraniKorisnik.ID_Korisnik)
                .GroupBy(g => g.Film.Zanr.Naziv)
                .Select(gr => new { Zanr = gr.Key, Broj = gr.Count() })
                .OrderByDescending(z => z.Broj)
                .FirstOrDefault();

            var filmStat = DB_Entities.Gleda
                .Where(g => g.ID_Korisnik == OdabraniKorisnik.ID_Korisnik)
                .GroupBy(g => g.Film.Naziv)
                .Select(gr => new { Film = gr.Key, Broj = gr.Count() })
                .OrderByDescending(f => f.Broj)
                .FirstOrDefault();

            lblNajzanr.Text = zanrStat != null ? $"Najgledaniji žanr: {zanrStat.Zanr} ({zanrStat.Broj})" : "Nema podataka";
            lblNajfilm.Text = filmStat != null ? $"Najgledaniji film: {filmStat.Film} ({filmStat.Broj})" : "Nema podataka";
        }
    }
}
