using System;
using System.Collections.Generic;
using System.Windows.Forms;

namespace VideoMaster
{
    public partial class formPovijestGledanja : Form
    {
        private PI2324_02_DBEntities DB_Entities;
        private Korisnik OdabraniKorisnik;

        public formPovijestGledanja(Korisnik korisnik)
        {
            InitializeComponent();
            DB_Entities = new PI2324_02_DBEntities();
            OdabraniKorisnik = korisnik;
            UcitajPovijest();
            UcitajStatistiku();
        }

        private void UcitajPovijest()
        {
            var lista = new List<FilmInfo>();
            foreach (var gleda in DB_Entities.Gleda)
            {
                if (gleda.ID_Korisnik == OdabraniKorisnik.ID_Korisnik)
                {
                    var info = new FilmInfo();

                    if (gleda.Film != null)
                    {
                        info.ID_Film = gleda.Film.ID_Film;
                        info.Naziv = gleda.Film.Naziv;
                        if (gleda.Film.Zanr != null)
                        {
                            info.Zanr = gleda.Film.Zanr.Naziv;
                        }
                        else
                        {
                            info.Zanr = "";
                        }
                        info.Adresa_url = gleda.Film.Adresa_url;
                        info.Trajanje = gleda.Film.Trajanje;
                        if (gleda.Film.Redatelj != null)
                        {
                            info.Redatelj = gleda.Film.Redatelj.Ime + " " + gleda.Film.Redatelj.Prezime;
                        }
                        else
                        {
                            info.Redatelj = "";
                        }
                        if (gleda.Film.DobnoOgranicenje != null)
                        {
                            info.DobnoOgranicenje = gleda.Film.DobnoOgranicenje.Naziv;
                        }
                        else
                        {
                            info.DobnoOgranicenje = "";
                        }
                    }
                    else
                    {
                        info.ID_Film = 0;
                        info.Naziv = "";
                        info.Zanr = "";
                        info.Adresa_url = "";
                        info.Trajanje = 0;
                        info.Redatelj = "";
                        info.DobnoOgranicenje = "";
                    }
                    if (gleda.Ocjena.HasValue)
                    {
                        info.ProsjecnaOcjena = gleda.Ocjena.Value;
                    }
                    else
                    {
                        info.ProsjecnaOcjena = 0;
                    }
                    info.Datum_izdavanja = gleda.Datum_gledanja;
                    lista.Add(info);
                }
            }
            dgvPovijest.DataSource = lista;
        }

        private void UcitajStatistiku()
        {
            // Brojanje najgledanijeg žanra
            string najzanr = "Nema podataka";
            int maxZanr = 0;
            var zanrovi = new List<string>();
            var zanrCount = new List<int>();

            // Brojanje najgledanijeg filma
            string najfilm = "Nema podataka";
            int maxFilm = 0;
            var filmovi = new List<string>();
            var filmCount = new List<int>();

            foreach (var gleda in DB_Entities.Gleda)
            {
                if (gleda.ID_Korisnik == OdabraniKorisnik.ID_Korisnik)
                {
                    // Žanr
                    if (gleda.Film != null && gleda.Film.Zanr != null)
                    {
                        string zanr = gleda.Film.Zanr.Naziv;
                        int index = zanrovi.IndexOf(zanr);
                        if (index == -1)
                        {
                            zanrovi.Add(zanr);
                            zanrCount.Add(1);
                        }
                        else
                        {
                            zanrCount[index]++;
                        }
                        if (zanrCount[index == -1 ? zanrovi.Count - 1 : index] > maxZanr)
                        {
                            maxZanr = zanrCount[index == -1 ? zanrovi.Count - 1 : index];
                            najzanr = $"{zanr} ({maxZanr})";
                        }
                    }
                    // Film
                    if (gleda.Film != null)
                    {
                        string film = gleda.Film.Naziv;
                        int index = filmovi.IndexOf(film);
                        if (index == -1)
                        {
                            filmovi.Add(film);
                            filmCount.Add(1);
                        }
                        else
                        {
                            filmCount[index]++;
                        }
                        if (filmCount[index == -1 ? filmovi.Count - 1 : index] > maxFilm)
                        {
                            maxFilm = filmCount[index == -1 ? filmovi.Count - 1 : index];
                            najfilm = $"{film} ({maxFilm})";
                        }
                    }
                }
            }
            lblNajzanr.Text = $"Najgledaniji žanr: {najzanr}";
            lblNajfilm.Text = $"Najgledaniji film: {najfilm}";
        }
    }
}
