using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace VideoMaster
{
    public partial class formRegistracija : Form
    {
        private PI2324_02_DBEntities DB_Entities = new PI2324_02_DBEntities();

        public formRegistracija()
        {
            InitializeComponent();

            helpProvider1 = new HelpProvider();
            string baseDirectory = AppDomain.CurrentDomain.BaseDirectory;
            string projectDirectory = Directory.GetParent(baseDirectory).Parent.Parent.FullName;
            string documentationPath = Path.Combine(projectDirectory, "F1", "formRegistracija.html");

            if (!File.Exists(documentationPath))
            {
                MessageBox.Show("Datoteka s dokumentacijom ne postoji: " + documentationPath);
            }
            else
            {
                helpProvider1.HelpNamespace = documentationPath;
                helpProvider1.SetHelpNavigator(this, HelpNavigator.TableOfContents);
            }

            btnRegistracija.Click += btnRegistracija_Click;
        }

        protected override bool ProcessCmdKey(ref Message msg, Keys keyData)
        {
            if (keyData == Keys.F1)
            {
                // Otvori dokumentaciju pomoću HelpProvider kontrole
                Help.ShowHelp(this, helpProvider1.HelpNamespace);
                return true;
            }
            return base.ProcessCmdKey(ref msg, keyData);
        }

        private void btnNatrag_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        private void btnRegistracija_Click(object sender, EventArgs e)
        {
            string ime = txtIme.Text.Trim();
            string prezime = txtPrezime.Text.Trim();
            string korisnickoIme = txtKorisnickoIme.Text.Trim();
            string email = txtEmail.Text.Trim();
            string lozinka = txtLozinka.Text;
            string potvrdiLozinku = txtPotvrdiLozinku.Text;

            // Osnovna validacija
            if (string.IsNullOrWhiteSpace(ime) || string.IsNullOrWhiteSpace(prezime) ||
                string.IsNullOrWhiteSpace(korisnickoIme) || string.IsNullOrWhiteSpace(email) ||
                string.IsNullOrWhiteSpace(lozinka) || string.IsNullOrWhiteSpace(potvrdiLozinku))
            {
                MessageBox.Show("Sva polja su obavezna!");
                return;
            }
            if (lozinka != potvrdiLozinku)
            {
                MessageBox.Show("Lozinke se ne podudaraju!");
                return;
            }
            // Provjera jedinstvenosti korisničkog imena
            if (DB_Entities.Korisnik.Any(k => k.Nadimak == korisnickoIme))
            {
                MessageBox.Show("Korisničko ime je već zauzeto!");
                return;
            }
            // Dodavanje korisnika
            var noviKorisnik = new Korisnik
            {
                Ime = ime,
                Prezime = prezime,
                Nadimak = korisnickoIme,
                Email = email,
                Lozinka = lozinka,
                Datum_izrade_racuna = DateTime.Now,
                ID_Uloga = 3 // Pretpostavljamo da je 3 za individualnog korisnika
            };
            DB_Entities.Korisnik.Add(noviKorisnik);
            try
            {
                DB_Entities.SaveChanges();
                MessageBox.Show("Registracija uspješna! Sada se možete prijaviti.");
                this.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Registracija nije uspjela: {ex.Message}");
            }
        }
    }
}
