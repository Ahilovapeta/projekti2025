using System;
using System.Collections.Generic;
using System.Windows.Forms;

namespace VideoMaster
{
    // Forma za prikaz povijesti gledanja i statistike za individualnog korisnika
    public partial class formPovijestGledanja : Form
    {
        private PI2324_02_DBEntities DB_Entities;
        private Korisnik OdabraniKorisnik;

        // Konstruktor - prima korisnika i učitava podatke
        public formPovijestGledanja(Korisnik korisnik)
        {
            InitializeComponent();
            DB_Entities = new PI2324_02_DBEntities();
            OdabraniKorisnik = korisnik;
            UcitajPovijest();    // Prikazuje sve filmove koje je korisnik gledao
            UcitajStatistiku(); // Prikazuje najgledaniji žanr i film
        }

        // Učitava povijest gledanja za korisnika i prikazuje u DataGridView
        private void UcitajPovijest()
        {
            var lista = new List<FilmInfo>();
            foreach (var gleda in DB_Entities.Gleda)
            {
                // Dodaje film u listu ako ga je gledao odabrani korisnik
                if (gleda.ID_Korisnik == OdabraniKorisnik.ID_Korisnik)
                {
                    var info = new FilmInfo();
                    // Popunjavanje podataka o filmu
                    if (gleda.Film != null)
                    {
                        info.ID_Film = gleda.Film.ID_Film;
                        info.Naziv = gleda.Film.Naziv;
                        // Dodaje naziv žanra ako postoji
                        if (gleda.Film.Zanr != null)
                            info.Zanr = gleda.Film.Zanr.Naziv;
                        else
                            info.Zanr = "";
                        info.Adresa_url = gleda.Film.Adresa_url;
                        info.Trajanje = gleda.Film.Trajanje;
                        // Dodaje redatelja ako postoji
                        if (gleda.Film.Redatelj != null)
                            info.Redatelj = gleda.Film.Redatelj.Ime + " " + gleda.Film.Redatelj.Prezime;
                        else
                            info.Redatelj = "";
                        // Dodaje dobno ograničenje ako postoji
                        if (gleda.Film.DobnoOgranicenje != null)
                            info.DobnoOgranicenje = gleda.Film.DobnoOgranicenje.Naziv;
                        else
                            info.DobnoOgranicenje = "";
                    }
                    else
                    {
                        // Ako film ne postoji, postavi prazne podatke
                        info.ID_Film = 0;
                        info.Naziv = "";
                        info.Zanr = "";
                        info.Adresa_url = "";
                        info.Trajanje = 0;
                        info.Redatelj = "";
                        info.DobnoOgranicenje = "";
                    }
                    // Dodaje ocjenu ako postoji
                    if (gleda.Ocjena.HasValue)
                        info.ProsjecnaOcjena = gleda.Ocjena.Value;
                    else
                        info.ProsjecnaOcjena = 0;
                    // Dodaje datum gledanja
                    info.Datum_izdavanja = gleda.Datum_gledanja;
                    lista.Add(info);
                }
            }
            // Prikazuje listu filmova u DataGridView
            dgvPovijest.DataSource = lista;
        }

        // Pomoćna klasa za brojanje pojavljivanja žanrova i filmova
        private class Brojac
        {
            public string Naziv { get; set; }
            public int Broj { get; set; }
        }

        // Učitava statistiku gledanja: najgledaniji žanr i najgledaniji film
        private void UcitajStatistiku()
        {
            string najzanr = "Nema podataka";
            int maxZanr = 0;
            var brojacZanrova = new List<Brojac>();

            string najfilm = "Nema podataka";
            int maxFilm = 0;
            var brojacFilmova = new List<Brojac>();

            foreach (var gleda in DB_Entities.Gleda)
            {
                if (gleda.ID_Korisnik == OdabraniKorisnik.ID_Korisnik)
                {
                    // Brojanje žanrova
                    if (gleda.Film != null && gleda.Film.Zanr != null)
                    {
                        string zanr = gleda.Film.Zanr.Naziv;
                        bool pronaden = false;
                        foreach (var b in brojacZanrova)
                        {
                            if (b.Naziv == zanr)
                            {
                                b.Broj++;
                                pronaden = true;
                                if (b.Broj > maxZanr)
                                {
                                    maxZanr = b.Broj;
                                    najzanr = $"{zanr} ({maxZanr})";
                                }
                                break;
                            }
                        }
                        if (!pronaden)
                        {
                            brojacZanrova.Add(new Brojac { Naziv = zanr, Broj = 1 });
                            if (1 > maxZanr)
                            {
                                maxZanr = 1;
                                najzanr = $"{zanr} (1)";
                            }
                        }
                    }
                    // Brojanje filmova
                    if (gleda.Film != null)
                    {
                        string film = gleda.Film.Naziv;
                        bool pronaden = false;
                        foreach (var b in brojacFilmova)
                        {
                            if (b.Naziv == film)
                            {
                                b.Broj++;
                                pronaden = true;
                                if (b.Broj > maxFilm)
                                {
                                    maxFilm = b.Broj;
                                    najfilm = $"{film} ({maxFilm})";
                                }
                                break;
                            }
                        }
                        if (!pronaden)
                        {
                            brojacFilmova.Add(new Brojac { Naziv = film, Broj = 1 });
                            if (1 > maxFilm)
                            {
                                maxFilm = 1;
                                najfilm = $"{film} (1)";
                            }
                        }
                    }
                }
            }
            // Prikaz statistike na formi
            txtNajzanr.Text = $"Najgledaniji žanr: {najzanr}";
            txtNajfilm.Text = $"Najgledaniji film: {najfilm}";
        }

        // Event handler za povratak na početnu formu individualnog korisnika
        private void btnNatrag_Click(object sender, EventArgs e)
        {
            this.Hide();
            var pocetnaForm = new formIndividualniKorisnikPocetna(OdabraniKorisnik);
            pocetnaForm.ShowDialog();
            this.Close();
        }
    }
}
